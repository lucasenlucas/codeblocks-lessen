<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Codeblocks Kanban</title>

  <!-- ðŸ”¹ Styling -->
  <style>
    :root {
      --bg      : #f6f8ff;
      --white   : #ffffff;
      --card    : #dceeff;
      --shadow  : 0 2px 8px rgba(0,0,0,.1);
      --radius  : 12px;
      --gap     : 20px;
    }

    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: system-ui, sans-serif;
      background : var(--bg);
      padding    : 24px;
    }

    h1 { text-align:center; margin-bottom:24px; }

    .board {
      display:flex;
      gap:var(--gap);
      justify-content:center;
      flex-wrap:wrap;
    }

    .list {
      background   : var(--white);
      border-radius: var(--radius);
      padding      : 16px;
      width        : 300px;
      box-shadow   : var(--shadow);
      display:flex;
      flex-direction:column;
    }

    .list h2 { margin-bottom:12px; font-size:1.2rem; }

    .card {
      background   : var(--card);
      border-radius: 8px;
      padding      : 12px;
      margin-bottom: 12px;
      cursor:grab;
      user-select:none;
    }
  </style>
</head>

<body>
  <h1>ðŸ“‹ Mijn Kanban-bord</h1>

  <div class="board">
    <div id="todo"       class="list"><h2>To Do</h2></div>
    <div id="inprogress" class="list"><h2>In Progress</h2></div>
    <div id="done"       class="list"><h2>Done</h2></div>
  </div>

  <!-- ðŸ”¹ SortableJS voor drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- ðŸ”¹ Firebase + app-logica -->
  <script type="module">
    /* ---------------- Firebase initialiseren ---------------- */
    import { initializeApp }     from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth,
             onAuthStateChanged }from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore,
             collection,
             query,
             onSnapshot,
             doc,
             updateDoc }        from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:            "AIzaSyA0LcMrF62nVwXMtJFpDcPB7bviEZl7Vuk",
      authDomain:        "codeblocks-app.firebaseapp.com",
      projectId:         "codeblocks-app",
      storageBucket:     "codeblocks-app.firebasestorage.app",
      messagingSenderId: "341679011888",
      appId:             "1:341679011888:web:125666a5a4b0ff9701d5f5"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ---------------- UI-helpers ---------------- */
    function createCard(id, data) {
      const el      = document.createElement('div');
      el.className  = 'card';
      el.dataset.id = id;
      el.textContent= data.title ?? '(geen titel)';
      return el;
    }

    /* ---------------- Live-sync + drag-n-drop ---------------- */
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert('Je bent niet ingelogd â€“ ga naar de loginpagina.');
        location.href = 'index.html';
        return;
      }

      /* ðŸ”„ Real-time kaarten ophalen */
      const q = query(collection(db, 'kanbanCards'));
      onSnapshot(q, snapshot => {
        snapshot.docChanges().forEach(change => {
          const data = change.doc.data();
          const listId   = data.list?.toLowerCase().replaceAll(' ', '');
          const listElm  = document.getElementById(listId);
          if (!listElm) return;

          if (change.type === 'added') {
            const cardElm = createCard(change.doc.id, data);
            listElm.appendChild(cardElm);
          }
          if (change.type === 'removed') {
            const cardElm = document.querySelector(`.card[data-id="${change.doc.id}"]`);
            cardElm?.remove();
          }
          if (change.type === 'modified') {
            const cardElm = document.querySelector(`.card[data-id="${change.doc.id}"]`);
            if (cardElm && cardElm.parentElement.id !== listId) {
              cardElm.remove();
              listElm.appendChild(cardElm);
            }
            cardElm.textContent = data.title;
          }
        });
      });

      /* ðŸ–±ï¸ Drag-n-drop voor elke lijst */
      ['todo','inprogress','done'].forEach(id => {
        Sortable.create(document.getElementById(id), {
          group: 'kanban',
          animation: 150,
          onEnd: async e => {
            const cardId  = e.item.dataset.id;
            const newList = e.to.id;                  // todo / inprogress / done
            const listStr = newList === 'todo' ? 'To Do' : newList === 'inprogress' ? 'In Progress' : 'Done';
            try {
              await updateDoc(doc(db,'kanbanCards',cardId), { list: listStr });
            } catch(err) {
              console.error(err);
              alert('Opslaan mislukt â€“ probeer opnieuw.');
            }
          }
        });
      });
    });
  </script>
</body>
</html>
