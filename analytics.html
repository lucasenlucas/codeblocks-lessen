<!-- analytics.html (admin-only) -->
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analytics - Codeblocks</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>
  <style>
    :root{--bg:#070a19;--bg2:#10152f;--card:#11182f;--cardH:#1d2542;--txt:#e7e9f7;--muted:#8a8fae;--pri:#7355ff;--pri2:#a18bff;--danger:#ff4a4a;--r:1rem}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt);display:flex;min-height:100vh}
    a{color:inherit;text-decoration:none}

    .sidebar{width:220px;background:var(--bg2);padding:2rem 1rem;display:flex;flex-direction:column;gap:1rem}
    .sidebar h2{color:var(--pri);text-align:center;margin-bottom:1.2rem}
    .menu-item{padding:.75rem 1rem;border-radius:var(--r);color:var(--txt)}
    .menu-item:hover{background:var(--pri);color:#fff}
    .logout{background:var(--danger);color:#fff;border-radius:var(--r);text-align:center}

    .main{flex:1;padding:2rem;max-width:1200px;margin-inline:auto}
    h1{font-size:2rem;margin-bottom:1.2rem}

    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:1rem;margin-bottom:1.4rem}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:1rem;padding:1rem}
    .card .label{color:var(--muted);font-size:.9rem}
    .card .value{font-size:1.6rem;font-weight:900}

    .panel{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:1rem;padding:1rem}
    .muted{color:var(--muted)}
    .error{color:#ffb4b4}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Codeblocks</h2>
    <a class="menu-item" href="dashboard.html">Dashboard</a>
    <a class="menu-item" href="profiel.html">Profiel</a>
    <a class="menu-item" href="demo.html">Demo-aanvragen</a>
    <a class="menu-item" href="analytics.html">Analytics</a>
    <a class="logout" id="logout">Log uit</a>
  </aside>

  <main class="main">
    <h1>Analytics</h1>

    <div id="guard" class="muted" style="display:none">Bezig met rechten controleren…</div>

    <section id="content" style="display:none">
      <div class="cards" id="cards">
        <!-- wordt gevuld -->
      </div>

      <div class="panel">
        <div style="display:flex;gap:.6rem;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div class="muted">Tijdsperiode: <span id="range">laatste 7 dagen</span></div>
          <div>
            <select id="rangeSel" style="background:#0f132c;border:1px solid rgba(255,255,255,.12);border-radius:.6rem;padding:.5rem .7rem;color:var(--txt)">
              <option value="7daysAgo,today">7 dagen</option>
              <option value="28daysAgo,today">28 dagen</option>
              <option value="90daysAgo,today">90 dagen</option>
            </select>
          </div>
        </div>
        <canvas id="pvChart" height="120" style="margin-top:1rem"></canvas>
      </div>

      <p class="muted" style="margin-top:.75rem">Bron: Google Analytics 4 (Data API).</p>
      <p id="err" class="error" style="display:none"></p>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ====== Firebase init ======
    const firebaseConfig = {
      apiKey: "AIzaSyA0LcMrF62nVwXMtJFpDcPB7bviEZl7Vuk",
      authDomain: "codeblocks-app.firebaseapp.com",
      projectId: "codeblocks-app",
      storageBucket: "codeblocks-app.appspot.com",
      messagingSenderId: "341679011888",
      appId: "1:341679011888:web:125666a5a4b0ff9701d5f5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ====== Admin guard ======
    const guard = document.getElementById("guard");
    const content = document.getElementById("content");
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href = "index.html"; return; }
      guard.style.display = "block";
      const snap = await getDoc(doc(db,"users",user.uid));
      const role = (snap.data()?.role || "").toLowerCase();
      if(role !== "admin"){
        alert("⛔ Geen toegang tot Analytics.");
        location.href = "dashboard.html";
        return;
      }
      guard.style.display = "none";
      content.style.display = "block";
      initAnalyticsUI();
    });

    document.getElementById("logout").addEventListener("click", ()=> signOut(auth).then(()=>location.href="index.html"));

    // ====== UI helpers ======
    function card(label, value){
      return `<div class="card"><div class="label">${label}</div><div class="value">${Number(value||0).toLocaleString("nl-NL")}</div></div>`;
    }

    // ====== GA fetch + render ======
    const FUNCTION_URL = "https://<REGIO>-<PROJECT>.cloudfunctions.net/analyticsSummary"; // <-- vul jouw URL in

    let chart;
    async function fetchAnalytics(range="7daysAgo,today"){
      const [from,to] = range.split(",");
      const url = `${FUNCTION_URL}?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(`API ${r.status}`);
      return r.json();
    }

    async function initAnalyticsUI(){
      const rangeSel = document.getElementById("rangeSel");
      const rangeLbl = document.getElementById("range");
      const cards = document.getElementById("cards");
      const err = document.getElementById("err");

      async function load(range){
        err.style.display = "none";
        try{
          const data = await fetchAnalytics(range);
          const s = data.summary || {};
          const ev = data.events || {};
          cards.innerHTML =
            card("Total users", s.totalUsers) +
            card("Active users", s.activeUsers) +
            card("Sessions", s.sessions) +
            card("Page views", s.pageViews) +
            card("Demo start", ev.demo_request_start || 0) +
            card("Demo success", ev.demo_request_success || 0);

          // chart.js lazy load
          await new Promise((res, rej)=>{
            if(window.Chart) return res();
            const sc = document.createElement("script");
            sc.src = "https://cdn.jsdelivr.net/npm/chart.js";
            sc.onload = res; sc.onerror = rej; document.body.appendChild(sc);
          });

          const ctx = document.getElementById("pvChart").getContext("2d");
          const labels = (data.series||[]).map(p => p.date);
          const values = (data.series||[]).map(p => p.pageViews);

          if(chart){ chart.destroy(); }
          chart = new window.Chart(ctx, {
            type: "line",
            data: { labels, datasets: [{ label: "Page views", data: values, tension:.3 }] },
            options: {
              plugins:{ legend:{ display:false } },
              scales:{ y:{ beginAtZero:true, ticks:{ color:"#e7e9f7"} }, x:{ ticks:{ color:"#8a8fae"} } }
            }
          });

          // label
          const [from,to] = (data.range||{from:"",to:""}); // object with from,to
          rangeLbl.textContent = rangeSel.options[rangeSel.selectedIndex].textContent;
        }catch(e){
          console.error(e);
          err.textContent = "Kon analytics niet laden. Check of de Cloud Function draait en CORS is toegestaan.";
          err.style.display = "block";
        }
      }

      await load(rangeSel.value);
      rangeSel.addEventListener("change", ()=> load(rangeSel.value));
    }
  </script>
</body>
</html>
