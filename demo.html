<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Codeblocks</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --clr-bg:#070a19; --clr-bg-accent:#10152f; --clr-primary:#7355ff; --clr-primary-light:#a18bff;
      --clr-danger:#ff4a4a; --clr-text:#e7e9f7; --clr-text-muted:#8a8fae;
      --clr-card-bg:#11182f; --clr-card-hover:#1d2542; --radius:1rem; --transition:220ms ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:"Inter",sans-serif;background:var(--clr-bg);color:var(--clr-text);display:flex;height:100vh;overflow:hidden}

    .sidebar{width:220px;background:var(--clr-bg-accent);padding:2rem 1rem;display:flex;flex-direction:column;gap:1rem;box-shadow:2px 0 10px #0003;animation:slideInLeft .6s ease forwards}
    @keyframes slideInLeft{0%{transform:translateX(-100%);opacity:0}100%{transform:translateX(0);opacity:1}}
    .sidebar h2{font-size:1.4rem;margin-bottom:1.5rem;text-align:center;color:var(--clr-primary)}
    .menu-item{font-size:1rem;color:var(--clr-text);padding:.75rem 1rem;border-radius:var(--radius);transition:var(--transition);cursor:pointer;text-decoration:none}
    .menu-item:hover{background:var(--clr-primary);color:#fff;box-shadow:0 0 10px var(--clr-primary-light)}
    .menu-item.logout{background:var(--clr-danger);color:#fff}
    .menu-item.logout:hover{background:#e63939}
    .menu-item.active{background:var(--clr-primary);color:#fff}

    .main-content{flex:1;padding:2rem;overflow-y:auto;animation:fadeIn 1s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .section-title{font-size:2rem;margin-bottom:1.5rem}
    .search-bar{margin-bottom:2rem;max-width:500px}
    .search-bar input{width:100%;padding:.75rem 1rem;border-radius:var(--radius);border:none;background:#0f132c;color:var(--clr-text);font-size:1rem;box-shadow:0 0 8px #0006}
    .search-bar input:focus{outline:none;box-shadow:0 0 12px var(--clr-primary-light)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:2rem}
    .card{background:var(--clr-card-bg);padding:1.5rem;border-radius:var(--radius);box-shadow:0 4px 12px #0003;transition:transform .3s, box-shadow .3s;opacity:0;transform:translateY(20px);animation:fadeInCard .6s ease forwards}
    .card:hover{transform:scale(1.03);background:var(--clr-card-hover);box-shadow:0 6px 18px #0004}
    @keyframes fadeInCard{to{opacity:1;transform:translateY(0)}}
    .card-title{font-size:1.1rem;font-weight:700;margin-bottom:.5rem}
    .card-subtitle{font-size:.95rem;color:var(--clr-text-muted);margin-bottom:1rem}
    .card a{color:var(--clr-primary-light);text-decoration:none;font-weight:600}
    .muted{color:var(--clr-text-muted)}
    .badge{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.8rem;font-weight:700;}
    .badge.nieuw{background:#223256;color:#bcd3ff}
    .badge.inb{background:#2b3a20;color:#c5f1b2}
    .badge.afg{background:#3b2a2a;color:#f2c6c6}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .select, .btn{border:none;border-radius:.7rem;padding:.6rem .8rem;background:#0f132c;color:var(--clr-text);cursor:pointer}
    .btn.primary{background:var(--clr-primary)}
    .btn.primary:hover{background:var(--clr-primary-light)}
    .empty{color:var(--clr-text-muted);text-align:center;padding:2rem 0}
    .hidden{display:none}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Codeblocks</h2>
    <a class="menu-item active" data-view="modules">Dashboard</a>
    <a class="menu-item" data-view="profile">Profiel</a>
    <!-- Deze wordt dynamisch ingevoegd als role === 'admin' -->
    <a class="menu-item hidden" id="adminTab" data-view="demos">Demo-aanvragen</a>
    <div class="menu-item logout" id="logout">Log uit</div>
  </aside>

  <main class="main-content">
    <!-- ====== MODULES (default) ====== -->
    <section id="view-modules">
      <h1 class="section-title" id="welcome-title">Jouw Modules</h1>
      <div class="search-bar"><input type="text" id="search" placeholder="Zoek naar modules..."></div>
      <div class="grid" id="module-list"></div>
    </section>

    <!-- ====== PROFIEL ====== -->
    <section id="view-profile" class="hidden">
      <h1 class="section-title">Profiel</h1>
      <div class="grid">
        <div class="card">
          <div class="card-title" id="profiel-naam">Naam</div>
          <div class="card-subtitle"><span class="muted">Rol:</span> <span id="profiel-rol">â€”</span></div>
          <div class="card-subtitle"><span class="muted">Organisatie:</span> <span id="profiel-org">â€”</span></div>
          <div class="muted">Je profielgegevens komen uit <code>users/{uid}</code>.</div>
        </div>
      </div>
    </section>

    <!-- ====== DEMO-AANVRAGEN (ADMIN ONLY) ====== -->
    <section id="view-demos" class="hidden">
      <h1 class="section-title">Demo-aanvragen</h1>
      <div class="grid" id="demo-list"></div>
      <div id="demo-empty" class="empty hidden">Nog geen demo-aanvragen.</div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs, doc, getDoc,
      orderBy, onSnapshot, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ðŸ”§ jouw Firebase project
    const firebaseConfig = {
      apiKey: "AIzaSyA0LcMrF62nVwXMtJFpDcPB7bviEZl7Vuk",
      authDomain: "codeblocks-app.firebaseapp.com",
      projectId: "codeblocks-app",
      storageBucket: "codeblocks-app.appspot.com",
      messagingSenderId: "341679011888",
      appId: "1:341679011888:web:125666a5a4b0ff9701d5f5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const menuItems = document.querySelectorAll(".menu-item[data-view]");
    const views = {
      modules: document.getElementById("view-modules"),
      profile: document.getElementById("view-profile"),
      demos: document.getElementById("view-demos")
    };
    const adminTab = document.getElementById("adminTab");
    const logoutBtn = document.getElementById("logout");

    const moduleList = document.getElementById("module-list");
    const searchInput = document.getElementById("search");
    const welcomeTitle = document.getElementById("welcome-title");

    const profielNaam = document.getElementById("profiel-naam");
    const profielRol = document.getElementById("profiel-rol");
    const profielOrg = document.getElementById("profiel-org");

    const demoList = document.getElementById("demo-list");
    const demoEmpty = document.getElementById("demo-empty");

    let modulesData = [];
    let userRole = "user";

    // Simple view switcher
    function show(view){
      Object.values(views).forEach(v => v.classList.add("hidden"));
      views[view].classList.remove("hidden");
      menuItems.forEach(i => i.classList.toggle("active", i.dataset.view === view));
    }
    menuItems.forEach(i => i.addEventListener("click", () => show(i.dataset.view)));

    // Auth
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href = "index.html"; return; }

      // user doc
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const udata = userSnap.exists() ? userSnap.data() : {};
      const name = udata.name || "Gebruiker";
      userRole = (udata.role || "user").toLowerCase();
      const org = udata.organization || "â€”";

      // profile view fill
      profielNaam.textContent = name;
      profielRol.textContent = userRole;
      profielOrg.textContent = org;

      // header
      welcomeTitle.textContent = `Welkom ${name}, hier staan jouw modules`;

      // show/hide admin tab
      if(userRole === "admin"){
        adminTab.classList.remove("hidden");
      } else {
        adminTab.classList.add("hidden");
      }

      // modules query
      const mq = query(collection(db, "modules"), where("assignedTo", "array-contains", user.email));
      const ms = await getDocs(mq);
      modulesData = ms.docs.map(d => ({ id: d.id, ...d.data() }));
      renderModules(modulesData);

      // demos live (admin only)
      if(userRole === "admin"){
        const dq = query(collection(db, "demoRequests"), orderBy("createdAt", "desc"));
        onSnapshot(dq, (snap)=>{
          const items = [];
          snap.forEach(docu => items.push({ id: docu.id, ...docu.data() }));
          renderDemos(items);
        });
      }
    });

    function renderModules(data){
      moduleList.innerHTML = "";
      if(!data.length){
        moduleList.innerHTML = "<p class='empty'>Geen modules gevonden.</p>";
        return;
      }
      data.forEach((m, idx)=>{
        const card = document.createElement("div");
        card.className = "card";
        card.style.animationDelay = `${idx*0.05}s`;

        if(m.thumbnail){
          const img = document.createElement("img");
          img.src = m.thumbnail; img.alt = m.title || "Module"; img.style.width="100%";
          img.style.height="160px"; img.style.objectFit="cover"; img.style.borderRadius=".5rem"; img.style.marginBottom="1rem";
          card.appendChild(img);
        }
        const t = document.createElement("div"); t.className="card-title"; t.textContent = m.title || "Naamloze module";
        const s = document.createElement("div"); s.className="card-subtitle"; s.textContent = m.subtitle || "Codeblocks Lesmodule";
        const a = document.createElement("a"); a.href = m.url || "#"; a.target="_blank"; a.textContent = "Open module â†’";
        card.append(t,s,a);
        moduleList.appendChild(card);
      });
    }

    searchInput.addEventListener("input", ()=>{
      const term = searchInput.value.toLowerCase();
      const filtered = modulesData.filter(m => (m.title||"").toLowerCase().includes(term));
      renderModules(filtered);
    });

    // ----- DEMOS (admin) -----
    function renderDemos(items){
      demoList.innerHTML = "";
      demoEmpty.classList.toggle("hidden", items.length > 0);
      items.forEach((d, idx)=>{
        const card = document.createElement("div");
        card.className = "card";
        card.style.animationDelay = `${idx*0.04}s`;

        const status = (d.status||"nieuw").toLowerCase();
        const badge = `<span class="badge ${status === "nieuw" ? "nieuw" : status === "in behandeling" || status==="in_behandeling" ? "inb" : "afg"}">${status}</span>`;

        const title = document.createElement("div");
        title.className = "card-title";
        title.innerHTML = `${d.naam||"Onbekend"} <span class="muted">(${d.rol||"â€”"})</span> ${badge}`;

        const sub = document.createElement("div");
        sub.className = "card-subtitle";
        const interesses = Array.isArray(d.interesse) ? d.interesse.join(", ") : (d.interesse || "â€”");
        sub.innerHTML = `
          <div><span class="muted">E-mail:</span> ${d.email||"â€”"}</div>
          <div><span class="muted">Tel:</span> ${d.telefoon||"â€”"}</div>
          <div><span class="muted">Interesse:</span> ${interesses}</div>
          <div><span class="muted">Opmerking:</span> ${d.opmerking||"â€”"}</div>
        `;

        const row = document.createElement("div"); row.className = "row";
        const sel = document.createElement("select"); sel.className = "select";
        ["nieuw","in behandeling","afgerond"].forEach(s=>{
          const opt = document.createElement("option");
          opt.value = s; opt.textContent = s;
          if(s === status) opt.selected = true;
          sel.appendChild(opt);
        });
        const btn = document.createElement("button"); btn.className="btn primary"; btn.textContent="Opslaan";
        btn.addEventListener("click", async ()=>{
          btn.disabled = true; btn.textContent = "Opslaanâ€¦";
          try{
            await updateDoc(doc(db,"demoRequests", d.id), { status: sel.value });
            btn.textContent = "Opgeslagen";
            setTimeout(()=>{ btn.textContent="Opslaan"; btn.disabled=false; }, 800);
          }catch(e){
            console.error(e); btn.disabled=false; btn.textContent="Opslaan";
            alert("Updaten mislukt");
          }
        });
        row.append(sel, btn);

        card.append(title, sub, row);
        demoList.appendChild(card);
      });
    }

    // Logout
    logoutBtn.addEventListener("click", ()=> signOut(auth).then(()=> location.href="index.html"));

  </script>
</body>
</html>
