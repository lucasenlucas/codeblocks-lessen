<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Demo-aanvragen - Codeblocks</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#070a19; --bg2:#10152f; --card:#11182f; --cardH:#1d2542;
      --txt:#e7e9f7; --muted:#8a8fae; --pri:#7355ff; --pri2:#a18bff; --danger:#ff4a4a;
      --r:1rem;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt);display:flex;min-height:100vh}
    .sidebar{width:220px;background:var(--bg2);padding:2rem 1rem;display:flex;flex-direction:column;gap:1rem}
    .sidebar h2{color:var(--pri);text-align:center;margin-bottom:1.2rem}
    .menu-item{padding:.75rem 1rem;border-radius:var(--r);color:var(--txt);text-decoration:none}
    .menu-item:hover{background:var(--pri);color:#fff}
    .logout{background:var(--danger);color:#fff}
    .logout:hover{filter:brightness(.95)}
    .main{flex:1;padding:2rem;max-width:1200px;margin-inline:auto}
    .title{font-size:2rem;margin-bottom:1.2rem}

    /* list */
    .list{display:grid;gap:1rem}
    .card{background:var(--card);border-radius:.9rem;padding:1rem 1.1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:.2s}
    .card:hover{background:var(--cardH)}
    .left{display:flex;flex-direction:column;gap:.25rem}
    .name{font-weight:800}
    .school{color:var(--muted);font-size:.95rem}
    .right{display:flex;align-items:center;gap:.6rem}
    .badge{padding:.25rem .6rem;border-radius:999px;font-size:.8rem;font-weight:800}
    .b-nieuw{background:#223256;color:#bcd3ff}
    .b-inb{background:#2b3a20;color:#c5f1b2}
    .b-afg{background:#3b2a2a;color:#f2c6c6}

    /* modal */
    .modal-wrap{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);padding:1rem}
    .modal{width:min(720px,100%);background:var(--card);border:1px solid rgba(255,255,255,.07);border-radius:1rem;padding:1.2rem}
    .m-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .m-title{font-weight:900;font-size:1.2rem}
    .m-body{display:grid;gap:.6rem}
    .row{display:grid;grid-template-columns:140px 1fr;gap:.75rem;align-items:start}
    .lbl{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:.4rem}
    .chip{background:#0f132c;padding:.35rem .6rem;border-radius:999px;font-size:.85rem}
    .m-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:1rem}
    .btn{border:none;border-radius:.6rem;padding:.65rem .9rem;background:#0f132c;color:var(--txt);cursor:pointer}
    .btn.primary{background:var(--pri)}
    .btn.primary:hover{background:var(--pri2)}
    .btn.link{background:transparent;text-decoration:underline}
    .select{background:#0f132c;color:var(--txt);border:none;border-radius:.5rem;padding:.5rem .7rem}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Codeblocks</h2>
    <a class="menu-item" href="dashboard.html">Dashboard</a>
    <a class="menu-item" href="profiel.html">Profiel</a>
    <a class="menu-item" href="demo.html">Demo-aanvragen</a>
    <a class="menu-item logout" id="logout">Log uit</a>
  </aside>

  <main class="main">
    <h1 class="title">Demo-aanvragen</h1>
    <div id="list" class="list"></div>
    <p id="empty" style="color:var(--muted);margin-top:1rem;display:none">Nog geen demo-aanvragen.</p>
  </main>

  <!-- Modal -->
  <div id="modalWrap" class="modal-wrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="m-head">
        <div class="m-title" id="mTitle">Aanvraag</div>
        <button class="btn link" id="mClose">Sluiten ✕</button>
      </div>
      <div class="m-body">
        <div class="row"><div class="lbl">Naam</div><div id="mNaam">—</div></div>
        <div class="row"><div class="lbl">Rol</div><div id="mRol">—</div></div>
        <div class="row"><div class="lbl">School/org</div><div id="mSchool">—</div></div>
        <div class="row"><div class="lbl">E-mail</div><div id="mEmail">—</div></div>
        <div class="row"><div class="lbl">Telefoon</div><div id="mTel">—</div></div>
        <div class="row"><div class="lbl">Interesse</div><div id="mInteresse" class="chips"></div></div>
        <div class="row"><div class="lbl">Opmerking</div><div id="mOpm">—</div></div>
        <div class="row">
          <div class="lbl">Status</div>
          <div class="row" style="grid-template-columns:1fr auto;gap:.5rem">
            <select id="mStatus" class="select">
              <option>nieuw</option>
              <option>in behandeling</option>
              <option>afgerond</option>
            </select>
            <button id="mSave" class="btn primary">Opslaan</button>
          </div>
        </div>
      </div>
      <div class="m-actions">
        <a id="mailtoBtn" class="btn">Mail</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA0LcMrF62nVwXMtJFpDcPB7bviEZl7Vuk",
      authDomain: "codeblocks-app.firebaseapp.com",
      projectId: "codeblocks-app",
      storageBucket: "codeblocks-app.appspot.com",
      messagingSenderId: "341679011888",
      appId: "1:341679011888:web:125666a5a4b0ff9701d5f5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const logoutBtn = document.getElementById("logout");

    // Modal refs
    const modalWrap = document.getElementById("modalWrap");
    const mClose = document.getElementById("mClose");
    const mTitle = document.getElementById("mTitle");
    const mNaam = document.getElementById("mNaam");
    const mRol = document.getElementById("mRol");
    const mSchool = document.getElementById("mSchool");
    const mEmail = document.getElementById("mEmail");
    const mTel = document.getElementById("mTel");
    const mInteresse = document.getElementById("mInteresse");
    const mOpm = document.getElementById("mOpm");
    const mStatus = document.getElementById("mStatus");
    const mSave = document.getElementById("mSave");
    const mailtoBtn = document.getElementById("mailtoBtn");

    let currentId = null;
    let currentData = null;

    function openModal(){ modalWrap.style.display = "grid"; modalWrap.setAttribute("aria-hidden","false"); }
    function closeModal(){ modalWrap.style.display = "none"; modalWrap.setAttribute("aria-hidden","true"); currentId=null; currentData=null; }
    mClose.addEventListener("click", closeModal);
    modalWrap.addEventListener("click", (e)=>{ if(e.target === modalWrap) closeModal(); });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="index.html"; return; }
      // guard admin
      const u = await getDoc(doc(db,"users",user.uid));
      if(!u.exists() || (u.data().role||"").toLowerCase()!=="admin"){
        alert("⛔ Geen toegang."); location.href="dashboard.html"; return;
      }
      // live list
      const q = query(collection(db,"demoRequests"), orderBy("createdAt","desc"));
      onSnapshot(q,(snap)=>{
        listEl.innerHTML = "";
        if(snap.empty){ emptyEl.style.display="block"; return; }
        emptyEl.style.display="none";
        snap.forEach(d=>{
          const data = d.data();
          const status = (data.status||"nieuw").toLowerCase();
          const badgeClass = status==="nieuw"?"b-nieuw":status==="in behandeling"?"b-inb":"b-afg";
          const school = data.school || data.organisatie || data.organization || "—";
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="left">
              <div class="name">${data.naam||"Onbekend"}</div>
              <div class="school">${school}</div>
            </div>
            <div class="right">
              <span class="badge ${badgeClass}">${status}</span>
            </div>
          `;
          card.addEventListener("click", ()=>{
            currentId = d.id;
            currentData = data;
            // fill modal
            mTitle.textContent = `Aanvraag — ${data.naam||"Onbekend"}`;
            mNaam.textContent = data.naam || "—";
            mRol.textContent = data.rol || "—";
            mSchool.textContent = school;
            mEmail.textContent = data.email || "—";
            mTel.textContent = data.telefoon || "—";
            mOpm.textContent = data.opmerking || "—";
            // interesse chips
            mInteresse.innerHTML = "";
            const ints = Array.isArray(data.interesse) ? data.interesse : (data.interesse ? [data.interesse] : []);
            if(ints.length===0){ mInteresse.innerHTML = "<span class='muted'>—</span>"; }
            else { ints.forEach(x=>{ const c=document.createElement("span"); c.className="chip"; c.textContent=x; mInteresse.appendChild(c); }); }
            // status
            mStatus.value = (data.status||"nieuw").toLowerCase();
            // mailto
            const subject = encodeURIComponent(`Codeblocks — Demo-aanvraag (${data.naam||""})`);
            const body = encodeURIComponent(
`Beste ${data.naam||"—"},

Bedankt voor je demo-aanvraag bij Codeblocks.

Samenvatting:
• Rol: ${data.rol||"—"}
• School/organisatie: ${school}
• Interesse: ${ints.join(", ") || "—"}
• Opmerking: ${data.opmerking||"—"}

Graag hoor ik welke momenten passen voor een korte kennismaking.

Met vriendelijke groet,
Codeblocks`
            );
            const mail = data.email || "";
            mailtoBtn.href = `mailto:${mail}?subject=${subject}&body=${body}`;
            openModal();
          });
          listEl.appendChild(card);
        });
      });
    });

    mSave.addEventListener("click", async ()=>{
      if(!currentId) return;
      try{
        await updateDoc(doc(db,"demoRequests",currentId), { status: mStatus.value });
        mSave.textContent = "Opgeslagen";
        setTimeout(()=> mSave.textContent="Opslaan", 900);
      }catch(e){
        console.error(e); alert("Updaten mislukt");
      }
    });

    logoutBtn.addEventListener("click", ()=> signOut(auth).then(()=> location.href="index.html"));
  </script>
</body>
</html>
